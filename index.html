<!doctype html>
<html lang="ja" x-data="bonusPage()">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>マイページ｜賞与見込み（3タブ＋期間別サマリー）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
<main class="max-w-6xl mx-auto p-4 md:p-8">

  <!-- 見出し -->
  <header class="mb-6">
    <h1 class="text-2xl font-semibold">賞与見込み</h1>
    <p class="text-sm text-slate-500">金額は概算です。最終確定は勤怠・保険料等により変動します。</p>
  </header>

  <!-- タブ本体 -->
  <section class="bg-white rounded-2xl shadow p-6 md:p-8 mb-8" x-data="{tab:'current'}">
    <!-- タブ切替 -->
    <div class="flex gap-4 border-b mb-6">
      <button :class="tab==='current'?'border-b-2 border-indigo-500 text-indigo-600':'text-slate-500'"
              @click="tab='current'" class="pb-2 text-sm font-medium">2025年10月支給分（今回）</button>
      <button :class="tab==='previous'?'border-b-2 border-indigo-500 text-indigo-600':'text-slate-500'"
              @click="tab='previous'" class="pb-2 text-sm font-medium">2025年6月支給分（前回）</button>
      <button :class="tab==='prevprev'?'border-b-2 border-indigo-500 text-indigo-600':'text-slate-500'"
              @click="tab='prevprev'" class="pb-2 text-sm font-medium">2025年2月支給分（前々回）</button>
    </div>

    <!-- ====== タブ：今回（10月） ====== -->
    <div x-show="tab==='current'" x-cloak>
      <!-- サマリー -->
      <div class="bg-slate-50 rounded-xl p-4 mb-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs text-slate-500">支給額面（見込み）</p>
            <p class="text-3xl md:text-4xl font-bold" x-text="yen(current.fb)"></p>
          </div>
          <div class="text-right">
            <p class="text-xs text-slate-500">原資（EV＝FB＋会社負担＋前回持越）</p>
            <p class="text-lg font-semibold" x-text="yen(evOf(current))"></p>
          </div>
        </div>
        <!-- シンプル計算式 -->
        <div class="mt-3 text-sm">
          <ul class="space-y-1 text-slate-600">
            <li>FB ＝ 基礎賞与 <span class="font-semibold" x-text="yen(current.baseBonus)"></span> ＋ 超過還元 <span class="font-semibold" x-text="yen(current.extraReturn)"></span> ＋ 手当 <span class="font-semibold" x-text="yen(current.allowance)"></span></li>
            <li>EV ＝ FB <span class="font-semibold" x-text="yen(current.fb)"></span> ＋ 会社負担（健保＋厚年＋雇保） <span class="font-semibold" x-text="yen(burdenOf(current))"></span> ＋ 前回持越 <span class="font-semibold" x-text="signedYen(current.carryoverPrev)"></span></li>
          </ul>
          <p class="mt-1 text-xs text-slate-500">※会社負担は会社が支払うコストであり、手取りから差し引かれるものではありません。</p>
        </div>
      </div>

      <!-- 円グラフ＋凡例 -->
      <h3 class="font-medium mb-2">内訳（2025年10月支給分）</h3>
      <div class="grid md:grid-cols-3 gap-6 items-center">
        <div class="flex justify-center">
          <svg :width="size" :height="size" :viewBox="`0 0 ${size} ${size}`">
            <g :transform="`translate(${size/2},${size/2})`">
              <circle :r="radius" :cx="0" :cy="0" fill="none" class="stroke-slate-200" :stroke-width="thickness"></circle>
              <g x-html="segmentsSvg(itemsOf(current))"></g>
              <text text-anchor="middle" dy="6" class="fill-slate-600" style="font-size:12px;">内訳</text>
            </g>
          </svg>
        </div>
        <div class="md:col-span-2">
          <template x-for="grp in uiGroups(itemsOf(current))" :key="grp.group">
            <div class="mb-3">
              <p class="text-xs font-medium text-slate-500 mb-1" x-text="grp.group"></p>
              <ul class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <template x-for="it in grp.items" :key="it.label">
                  <li class="flex items-center gap-2 bg-slate-50 rounded px-3 py-1.5">
                    <span class="h-3 w-3 rounded-full" :style="`background:${it.color}`"></span>
                    <p class="text-sm" x-text="it.label"></p>
                    <p class="sr-only" x-text="yen(it.value)"></p>
                  </li>
                </template>
              </ul>
            </div>
          </template>
          <div class="text-xs text-slate-500">※小さい要素は「その他」にまとめる場合があります。</div>
        </div>
      </div>

      <!-- 月別サマリー（5〜8月） -->
      <div class="mt-8">
        <h3 class="font-medium mb-3">月別サマリー（対象期間：5〜8月）</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="py-2 pr-4">月</th>
                <th class="py-2 pr-4">単価</th>
                <th class="py-2 pr-4">月額原価</th>
                <th class="py-2 pr-4">賞与積立額</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="m in monthsCurrent" :key="m.month">
                <tr>
                  <td class="py-2 pr-4" x-text="m.month"></td>
                  <td class="py-2 pr-4" x-text="yen(m.unitPrice)"></td>
                  <td class="py-2 pr-4" x-text="yen(m.cost)"></td>
                  <td class="py-2 pr-4" x-text="yen(m.reserve)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ====== タブ：前回（6月） ====== -->
    <div x-show="tab==='previous'" x-cloak>
      <div class="bg-slate-50 rounded-xl p-4 mb-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs text-slate-500">支給額面（見込み）</p>
            <p class="text-3xl md:text-4xl font-bold" x-text="yen(previous.fb)"></p>
          </div>
          <div class="text-right">
            <p class="text-xs text-slate-500">原資（EV＝FB＋会社負担＋前回持越）</p>
            <p class="text-lg font-semibold" x-text="yen(evOf(previous))"></p>
          </div>
        </div>
        <div class="mt-3 text-sm">
          <ul class="space-y-1 text-slate-600">
            <li>FB ＝ 基礎賞与 <span class="font-semibold" x-text="yen(previous.baseBonus)"></span> ＋ 超過還元 <span class="font-semibold" x-text="yen(previous.extraReturn)"></span> ＋ 手当 <span class="font-semibold" x-text="yen(previous.allowance)"></span></li>
            <li>EV ＝ FB <span class="font-semibold" x-text="yen(previous.fb)"></span> ＋ 会社負担（健保＋厚年＋雇保） <span class="font-semibold" x-text="yen(burdenOf(previous))"></span> ＋ 前回持越 <span class="font-semibold" x-text="signedYen(previous.carryoverPrev)"></span></li>
          </ul>
          <p class="mt-1 text-xs text-slate-500">※会社負担は会社コストであり、手取りから控除するものではありません。</p>
        </div>
      </div>

      <h3 class="font-medium mb-2">内訳（2025年6月支給分）</h3>
      <div class="grid md:grid-cols-3 gap-6 items-center">
        <div class="flex justify-center">
          <svg :width="size" :height="size" :viewBox="`0 0 ${size} ${size}`">
            <g :transform="`translate(${size/2},${size/2})`">
              <circle :r="radius" :cx="0" :cy="0" fill="none" class="stroke-slate-200" :stroke-width="thickness"></circle>
              <g x-html="segmentsSvg(itemsOf(previous))"></g>
              <text text-anchor="middle" dy="6" class="fill-slate-600" style="font-size:12px;">内訳</text>
            </g>
          </svg>
        </div>
        <div class="md:col-span-2">
          <template x-for="grp in uiGroups(itemsOf(previous))" :key="grp.group">
            <div class="mb-3">
              <p class="text-xs font-medium text-slate-500 mb-1" x-text="grp.group"></p>
              <ul class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <template x-for="it in grp.items" :key="it.label">
                  <li class="flex items-center gap-2 bg-slate-50 rounded px-3 py-1.5">
                    <span class="h-3 w-3 rounded-full" :style="`background:${it.color}`"></span>
                    <p class="text-sm" x-text="it.label"></p>
                  </li>
                </template>
              </ul>
            </div>
          </template>
        </div>
      </div>

      <!-- 月別サマリー（1〜4月） -->
      <div class="mt-8">
        <h3 class="font-medium mb-3">月別サマリー（対象期間：1〜4月）</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="py-2 pr-4">月</th>
                <th class="py-2 pr-4">単価</th>
                <th class="py-2 pr-4">月額原価</th>
                <th class="py-2 pr-4">賞与積立額</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="m in monthsPrevious" :key="m.month">
                <tr>
                  <td class="py-2 pr-4" x-text="m.month"></td>
                  <td class="py-2 pr-4" x-text="yen(m.unitPrice)"></td>
                  <td class="py-2 pr-4" x-text="yen(m.cost)"></td>
                  <td class="py-2 pr-4" x-text="yen(m.reserve)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ====== タブ：前々回（2月） ====== -->
    <div x-show="tab==='prevprev'" x-cloak>
      <div class="bg-slate-50 rounded-xl p-4 mb-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs text-slate-500">支給額面（見込み）</p>
            <p class="text-3xl md:text-4xl font-bold" x-text="yen(prevprev.fb)"></p>
          </div>
          <div class="text-right">
            <p class="text-xs text-slate-500">原資（EV＝FB＋会社負担＋前回持越）</p>
            <p class="text-lg font-semibold" x-text="yen(evOf(prevprev))"></p>
          </div>
        </div>
        <div class="mt-3 text-sm">
          <ul class="space-y-1 text-slate-600">
            <li>FB ＝ 基礎賞与 <span class="font-semibold" x-text="yen(prevprev.baseBonus)"></span> ＋ 超過還元 <span class="font-semibold" x-text="yen(prevprev.extraReturn)"></span> ＋ 手当 <span class="font-semibold" x-text="yen(prevprev.allowance)"></span></li>
            <li>EV ＝ FB <span class="font-semibold" x-text="yen(prevprev.fb)"></span> ＋ 会社負担（健保＋厚年＋雇保） <span class="font-semibold" x-text="yen(burdenOf(prevprev))"></span> ＋ 前回持越 <span class="font-semibold" x-text="signedYen(prevprev.carryoverPrev)"></span></li>
          </ul>
        </div>
      </div>

      <h3 class="font-medium mb-2">内訳（2025年2月支給分）</h3>
      <div class="grid md:grid-cols-3 gap-6 items-center">
        <div class="flex justify-center">
          <svg :width="size" :height="size" :viewBox="`0 0 ${size} ${size}`">
            <g :transform="`translate(${size/2},${size/2})`">
              <circle :r="radius" :cx="0" :cy="0" fill="none" class="stroke-slate-200" :stroke-width="thickness"></circle>
              <g x-html="segmentsSvg(itemsOf(prevprev))"></g>
              <text text-anchor="middle" dy="6" class="fill-slate-600" style="font-size:12px;">内訳</text>
            </g>
          </svg>
        </div>
        <div class="md:col-span-2">
          <template x-for="grp in uiGroups(itemsOf(prevprev))" :key="grp.group">
            <div class="mb-3">
              <p class="text-xs font-medium text-slate-500 mb-1" x-text="grp.group"></p>
              <ul class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <template x-for="it in grp.items" :key="it.label">
                  <li class="flex items-center gap-2 bg-slate-50 rounded px-3 py-1.5">
                    <span class="h-3 w-3 rounded-full" :style="`background:${it.color}`"></span>
                    <p class="text-sm" x-text="it.label"></p>
                  </li>
                </template>
              </ul>
            </div>
          </template>
        </div>
      </div>

      <!-- 月別サマリー（9〜12月） -->
      <div class="mt-8">
        <h3 class="font-medium mb-3">月別サマリー（対象期間：9〜12月）</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="py-2 pr-4">月</th>
                <th class="py-2 pr-4">単価</th>
                <th class="py-2 pr-4">月額原価</th>
                <th class="py-2 pr-4">賞与積立額</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="m in monthsPrevPrev" :key="m.month">
                <tr>
                  <td class="py-2 pr-4" x-text="m.month"></td>
                  <td class="py-2 pr-4" x-text="yen(m.unitPrice)"></td>
                  <td class="py-2 pr-4" x-text="yen(m.cost)"></td>
                  <td class="py-2 pr-4" x-text="yen(m.reserve)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ（開閉式） -->
  <section class="bg-white rounded-2xl shadow p-6 md:p-8" x-data="{openIdx:null}">
    <h2 class="text-lg font-semibold mb-4">FAQ</h2>

    <div class="divide-y divide-slate-100">
      <div class="py-3">
        <button class="w-full text-left flex justify-between items-center"
                @click="openIdx = openIdx===1 ? null : 1">
          <span class="font-bold text-slate-700">会社負担の保険料が、なぜ個人の賞与に関係するの？</span>
          <span class="text-slate-400" x-text="openIdx===1?'−':'＋'"></span>
        </button>
        <div x-show="openIdx===1" x-collapse class="mt-2 text-sm text-slate-600">
          当社は還元率75%の枠内で会社負担の社会保険・雇用保険を含めて原資管理をしています。見かけ上「自分から引かれている」ように感じますが、実際には会社が支払うコストです。
        </div>
      </div>

      <div class="py-3">
        <button class="w-full text-left flex justify-between items-center"
                @click="openIdx = openIdx===2 ? null : 2">
          <span class="font-bold text-slate-700">単価が同じなのに、支給額が前回と違うのは？</span>
          <span class="text-slate-400" x-text="openIdx===2?'−':'＋'"></span>
        </button>
        <div x-show="openIdx===2" x-collapse class="mt-2 text-sm text-slate-600">
          契約時間・みなし残業の扱い等で会社負担が増減すると、月次の賞与積立額が変動します。その合算が賞与原資に反映されるため、同じ単価でも支給額が異なる場合があります。
        </div>
      </div>

      <div class="py-3">
        <button class="w-full text-left flex justify-between items-center"
                @click="openIdx = openIdx===3 ? null : 3">
          <span class="font-bold text-slate-700">表示金額は確定？</span>
          <span class="text-slate-400" x-text="openIdx===3?'−':'＋'"></span>
        </button>
        <div x-show="openIdx===3" x-collapse class="mt-2 text-sm text-slate-600">
          いいえ、ここでの金額は概算です。支給時点の勤怠・保険料率等により最終額は変動します。
        </div>
      </div>
    </div>
  </section>

</main>

<script>
function bonusPage(){
  return {
    /* 円グラフ見た目 */
    size:180, thickness:24,
    get radius(){return (this.size - this.thickness)/2},
    get circumference(){return 2*Math.PI*this.radius},

    /* データ：今回（10月）・前回（6月）・前々回（2月） */
    current:{  // 2025-10（対象：5〜8月）
      baseBonus:500000,  extraReturn:26000,  allowance:150000,
      healthIns:18000,   pension:22000,      employmentIns:11000,
      carryoverPrev:10000,
      get fb(){return this.baseBonus + this.extraReturn + this.allowance;}
    },
    previous:{ // 2025-06（対象：1〜4月）
      baseBonus:480000,  extraReturn:20000,  allowance:140000,
      healthIns:17500,   pension:21000,      employmentIns:10500,
      carryoverPrev:5000,
      get fb(){return this.baseBonus + this.extraReturn + this.allowance;}
    },
    prevprev:{ // 2025-02（対象：9〜12月）
      baseBonus:455000,  extraReturn:22000,  allowance:130000,
      healthIns:17000,   pension:20500,      employmentIns:10000,
      carryoverPrev:-8000,
      get fb(){return this.baseBonus + this.extraReturn + this.allowance;}
    },

    /* 月別サマリー：期間別データ（例値） */
    // 10月支給分 → 5〜8月
    monthsCurrent:[
      {month:'2025-05', unitPrice:1100000, cost:650000, reserve:180000},
      {month:'2025-06', unitPrice:1200000, cost:680000, reserve:200000},
      {month:'2025-07', unitPrice:1180000, cost:670000, reserve:195000},
      {month:'2025-08', unitPrice:1200000, cost:680000, reserve:200000},
    ],
    // 6月支給分 → 1〜4月
    monthsPrevious:[
      {month:'2025-01', unitPrice:1080000, cost:640000, reserve:175000},
      {month:'2025-02', unitPrice:1090000, cost:645000, reserve:178000},
      {month:'2025-03', unitPrice:1120000, cost:655000, reserve:185000},
      {month:'2025-04', unitPrice:1100000, cost:650000, reserve:180000},
    ],
    // 2月支給分 → 9〜12月（前年度想定でもOK）
    monthsPrevPrev:[
      {month:'2024-09', unitPrice:1060000, cost:635000, reserve:170000},
      {month:'2024-10', unitPrice:1070000, cost:638000, reserve:172000},
      {month:'2024-11', unitPrice:1090000, cost:642000, reserve:176000},
      {month:'2024-12', unitPrice:1110000, cost:648000, reserve:182000},
    ],

    /* 集計ユーティリティ */
    burdenOf(emp){ return (emp.healthIns||0)+(emp.pension||0)+(emp.employmentIns||0); },
    evOf(emp){ return (emp.fb||0)+this.burdenOf(emp)+(emp.carryoverPrev||0); },

    /* ドーナツ用データ生成（7項目） */
    itemsOf(emp){
      const raw = [
        {group:'支給分',   label:'基礎賞与', value:emp.baseBonus,  color:'#6366F1'},
        {group:'支給分',   label:'超過還元', value:emp.extraReturn,color:'#22C55E'},
        {group:'支給分',   label:'手当（開拓・紹介含む）', value:emp.allowance, color:'#F59E0B'},
        {group:'会社負担', label:'健康保険', value:emp.healthIns,  color:'#93C5FD'},
        {group:'会社負担', label:'厚生年金', value:emp.pension,    color:'#60A5FA'},
        {group:'会社負担', label:'雇用保険', value:emp.employmentIns, color:'#06B6D4'},
        {group:'調整',     label:'前回持越分', value:emp.carryoverPrev, color:'#A78BFA'},
      ];
      // 表示破綻防止：負値は0に丸め（実数は計算式で明記）
      return raw.map(it => ({...it, value: Math.max(0, +(it.value||0))}));
    },

    /* 円グラフセグメント（12時開始） */
    get circumference(){return 2*Math.PI*this.radius}, // 再定義防止のため念のため残す
    segments(items){
      const total = items.reduce((s,i)=>s+i.value,0) || 1;
      let acc = 0;
      return items.map(it=>{
        const len = (it.value/total)*this.circumference;
        const raw = (this.circumference*0.25) - acc;
        const offset = ((raw%this.circumference)+this.circumference)%this.circumference;
        acc += len;
        return {...it, len:+len.toFixed(2), offset:+offset.toFixed(2)};
      });
    },
    segmentsSvg(items){
      return this.segments(items).map(seg=>`
        <circle r="${this.radius}" cx="0" cy="0" fill="none"
          stroke="${seg.color}" stroke-width="${this.thickness}"
          stroke-dasharray="${seg.len} ${this.circumference - seg.len}"
          stroke-dashoffset="${seg.offset}" stroke-linecap="butt"></circle>
      `).join('');
    },

    /* 凡例のグルーピング */
    uiGroups(items){
      const groups={};
      for(const it of items){ (groups[it.group] ||= []).push(it); }
      const order=['支給分','会社負担','調整'];
      return order.filter(k=>groups[k]?.length).map(k=>({group:k, items:groups[k]}));
    },

    /* フォーマッタ */
    yen(n){return (n??0).toLocaleString('ja-JP',{style:'currency',currency:'JPY'}); },
    signedYen(n){
      const v=n??0, abs= Math.abs(v).toLocaleString('ja-JP',{style:'currency',currency:'JPY'}).replace('￥','¥');
      return (v>=0?'+':'−') + abs;
    }
  }
}
</script>
</body>
</html>
